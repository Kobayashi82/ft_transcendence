events {}

http {
    include       mime.types;
    default_type  application/octet-stream;

	# Log configuration in JSON format for better parsing
    log_format json_combined '{ "time": "$time_iso8601", '
                              '"remote_addr": "$remote_addr", '
                              '"remote_user": "$remote_user", '
                              '"request": "$request", '
                              '"status": "$status", '
                              '"body_bytes_sent": "$body_bytes_sent", '
                              '"http_referer": "$http_referer", '
                              '"http_user_agent": "$http_user_agent" }';

	access_log syslog:server=logstash:5044,tag=nginx;						# Send access logs to LogStash
    error_log syslog:server=logstash:5044,tag=nginx;						# Send error logs to LogStash

    # Performance optimizations
    server_tokens off;														# Hide nginx version
    sendfile on;															# Enable efficient file transfer
    tcp_nopush on;															# Optimize packet transmission for large responses
    tcp_nodelay on;															# Reduce latency for small, frequent packets
    keepalive_timeout 65;													# Set keep-alive timeout for persistent connections
    types_hash_max_size 2048;												# Increase the maximum size of the MIME types hash table

    # Security headers
    add_header X-Content-Type-Options nosniff;								# Prevent MIME type sniffing
    add_header X-XSS-Protection "1; mode=block";							# Enable basic XSS protection

    # Body size limits
    client_max_body_size 10M;												# Set maximum request body size
    client_body_buffer_size 128k;											# Set buffer size for request body

    # Gzip compression
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	# HTTP (80)
    server {
        listen 80;
        server_name [hostname] www.[hostname];

        # Redirect HTTP to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }

		# Endpoint for metrics
		location /metrics {
			stub_status on;
			allow 127.0.0.1;
			deny all;
		}
    }

	# HTTPS (443)
    server {
        listen 443 ssl;
        server_name [hostname] www.[hostname];

		# SSL Certificate
		ssl_certificate /etc/ssl/certs/server.crt;							# Path to SSL certificate file
		ssl_certificate_key /etc/ssl/private/server.key;					# Path to private key associated with the certificate

		# SSL Security Options
		ssl_protocols TLSv1.2 TLSv1.3;										# Only allow TLS 1.2 and 1.3 (more secure protocols)
		ssl_prefer_server_ciphers on;										# Prefer server-side cipher order over client preferences
		ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

		# OCSP Stapling (ignored for self-sign certificates)
		ssl_stapling on;
		ssl_stapling_verify on;

		# SSL Session Optimization
		ssl_session_cache shared:SSL:10m;									# 10MB shared cache for SSL sessions
		ssl_session_timeout 1d;												# Cache SSL sessions for 1 day
		ssl_session_tickets off;											# Disable TLS session tickets for better security

		# DNS Configuration
		resolver 127.0.0.11 8.8.8.8 8.8.4.4 valid=300s;						# Docker and Google DNS resolvers used for OCSP stapling verification
		resolver_timeout 5s;												# Timeout for DNS resolution

		# HTTP Security Headers
		add_header Strict-Transport-Security "max-age=2592000" always;		# HTTP Strict Transport Security (HSTS). Forces browsers to use HTTPS for this domain for 30 days

		# Frontend
		location / {
			# Routing
			if ($http_x_check_status = "1") {								# Check if it is a special verification request
				proxy_pass http://web:80;									# Forward requests to the frontend service
				break;
			}
			proxy_pass http://web:80;										# Forward requests to the frontend service
			proxy_redirect off;												# Disable automatic redirection

			# WebSocket
			proxy_http_version 1.1;											# Use HTTP/1.1 for proxy connections
			proxy_set_header Upgrade $http_upgrade;							# Required for WebSocket connections
			proxy_set_header Connection "upgrade";							# Enable connection upgrade for WebSockets

			# Headers
			proxy_set_header Host $host;									# Pass the original host header
			proxy_set_header X-Real-IP $remote_addr;						# Pass client's real IP
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;	# Pass all client IPs in proxy chain
			proxy_set_header X-Forwarded-Proto $scheme;						# Pass the protocol (HTTP/HTTPS)
			proxy_set_header X-Frame-Options "SAMEORIGIN";					# Prevent embedding in iframes from different origins
			proxy_set_header Accept-Encoding "";							# Skip already Gzip compressed assets

			# Cache
			proxy_cache_bypass $http_pragma $http_authorization;			# Skip cache when needed
			proxy_cache_valid 200 302 10m;									# Cache successful responses for 10 minutes
			proxy_cache_valid 404 1m;										# Cache not found responses for 1 minute

			# Buffer
			proxy_buffering on;												# Enable response buffering for better performance
			proxy_buffer_size 4k;											# Buffer size for response headers
			proxy_buffers 16 16k;											# Increased number of buffers for static assets
			proxy_busy_buffers_size 32k;									# Size of buffers that can be busy sending to client

			# Timeout
			proxy_connect_timeout 5s;										# Timeout for establishing connection with frontend
			proxy_send_timeout 20s;											# Timeout for sending request to frontend
			proxy_read_timeout 20s;											# Timeout for reading response from frontend

			# Errors
			proxy_intercept_errors on;										# Enable custom error handling
			error_page 502 503 504 = @fallback;								# Redirect errors to an error handler
		}

		# Fallback handler
		location @fallback {
			root /var/www/html;
			try_files /index.html =503;
		}

		# API Gateway
		location /api/ {
			# Routing
			set $gateway_upstream "gateway:3000";							# Define the upstream address
    		rewrite ^/api/(.*) /$1 break;									# Rewrites the request to a new format
			proxy_pass http://$gateway_upstream;							# Forward requests to the gateway service
			proxy_redirect off;												# Disable automatic redirection

			# WebSocket
			proxy_http_version 1.1;											# Use HTTP/1.1 for proxy connections
			proxy_set_header Upgrade $http_upgrade;        					# Required for WebSocket connections
			proxy_set_header Connection "upgrade";          				# Enable connection upgrade for WebSockets

			# Headers
			proxy_set_header Host $host;                    				# Pass the original host header
			proxy_set_header X-Real-IP $remote_addr;        				# Pass client's real IP
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 	# Pass all client IPs in proxy chain
			proxy_set_header X-Forwarded-Proto $scheme;						# Pass the protocol (HTTP/HTTPS)
			proxy_set_header X-Frame-Options "SAMEORIGIN";					# Prevent embedding in iframes from different origins

			# Buffer
			proxy_buffering on;												# Enable response buffering for better performance
			proxy_buffer_size 4k;											# Buffer size for response headers
			proxy_buffers 8 16k;											# Number and size of buffers for response body
			proxy_busy_buffers_size 32k;									# Size of buffers that can be busy sending to client

			# Timeout
			proxy_connect_timeout 10s;										# Timeout for establishing connection with gateway
			proxy_send_timeout 30s;											# Timeout for sending request to gateway
			proxy_read_timeout 60s;											# Timeout for reading response from gateway

			# Errors
			proxy_intercept_errors on;										# Enable custom error handling
    		error_page 502 503 504 = @proxy_error;							# Redirect errors to an error handler
		}

		# Kibana
		location /kibana/ {
			# Routing
			set $kibana_upstream "kibana:5601";
    		rewrite ^/kibana/(.*) /$1 break;
			proxy_pass http://$kibana_upstream;
			proxy_redirect off;

			# WebSocket
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";

			# Headers
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Frame-Options "SAMEORIGIN";
			
			# Buffer
			proxy_buffering on;
			proxy_buffer_size 4k;
			proxy_buffers 8 16k;
			proxy_busy_buffers_size 32k;

			# Timeout
			proxy_connect_timeout 10s;
			proxy_send_timeout 30s;
			proxy_read_timeout 90s;
			
			# Errors
			proxy_intercept_errors on;
    		error_page 502 503 504 = @proxy_error;

			# Prevent access to sensitive APIs
			location ~ /kibana/api/console/ {
				return 403;
			}
		}

		# Grafana
		location /grafana/ {
			# Routing
		    set $grafana_upstream "grafana:3000";
    		rewrite ^/grafana/(.*) /$1 break;
			proxy_pass http://$grafana_upstream;
			proxy_redirect off;

			# WebSocket
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";

			# Headers
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Frame-Options "SAMEORIGIN";
			
			# Buffer
			proxy_buffering on;
			proxy_buffer_size 4k;
			proxy_buffers 8 16k;
			proxy_busy_buffers_size 32k;

			# Timeout
			proxy_connect_timeout 10s;
			proxy_send_timeout 30s;
			proxy_read_timeout 60s;
			
			# Errors
			proxy_intercept_errors on;
    		error_page 502 503 504 = @proxy_error;

			# Prevent access to sensitive APIs
			location ~ /grafana/api/admin/ {
				return 403;
			}

		}

		# Error handler
		location @proxy_error {
			return 503;
		}

		# Borrar
		location /prometheus {
			set $prometheus_upstream "prometheus:9090";
			proxy_pass http://$prometheus_upstream;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_redirect off;
			proxy_intercept_errors on;
    		error_page 502 503 504 = @proxy_error;
		}

    }
}
